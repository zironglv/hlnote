name: Investment Report Generator

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

jobs:
  generate-investment-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run investment report generator
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
      run: |
        echo "ğŸš€ Starting investment report generation..."
        echo "=== è°ƒè¯•ä¿¡æ¯ ==="
        echo "Pythonç‰ˆæœ¬:"
        python --version
        echo "å½“å‰ç›®å½•æ–‡ä»¶:"
        ls -la
        echo "ç¯å¢ƒå˜é‡DINGTALK_WEBHOOKé•¿åº¦: ${#DINGTALK_WEBHOOK}"
        echo "=== è¿è¡Œä¸»ç¨‹åº ==="
        python main_multi_fixed.py 2>&1 | tee run_output.log
        REPORT_EXIT_CODE=$?
        echo "=== è¿è¡Œç»“æœ ==="
        echo "Report generation exit code: $REPORT_EXIT_CODE"
        echo "æ—¥å¿—æ–‡ä»¶å†…å®¹:"
        cat multi_index_dividend_analyzer.log 2>/dev/null || echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
        echo "è¿è¡Œè¾“å‡º:"
        cat run_output.log 2>/dev/null || echo "è¿è¡Œè¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨"
        if [ $REPORT_EXIT_CODE -eq 0 ]; then
          echo "âœ… Report generation completed successfully"
          echo "âœ… æ£€æŸ¥ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶:"
          find reports -name "index.html" -type f | head -10
        else
          echo "âš ï¸ Report generation completed with warnings (exit code: $REPORT_EXIT_CODE)"
        fi
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-reports
        path: |
          reports/
          *.log
        if-no-files-found: ignore