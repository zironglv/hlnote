name: Daily Investment Report

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei fonts-wqy-microhei ttf-wqy-zenhei ttf-wqy-microhei fonts-dejavu
        rm -rf ~/.cache/matplotlib
        pip install -r requirements.txt
        pip install openpyxl
        pip install xlrd>=2.0.1
        python -c "
import matplotlib.font_manager
matplotlib.font_manager._rebuild()
print('‚úÖ Font cache rebuilt')
fonts = matplotlib.font_manager.findSystemFonts(fontpaths=None, fontext='ttf')
chinese_fonts = [f for f in fonts if any(keyword in f.lower() for keyword in ['wqy', 'zenhei', 'microhei', 'songti', 'kaiti', 'heiti'])]
print(f'‚úÖ Found {len(chinese_fonts)} Chinese font files')
"
        
    - name: Configure environment
      run: |
        echo "Using DingTalk robot for notifications"
        echo "Configuration check completed"
        echo "Python version: $(python --version)"
        echo "pip version: $(pip --version)"
        
    - name: Configure DingTalk Webhook
      run: |
        if [ -z "$DINGTALK_WEBHOOK" ]; then
          echo "‚ö†Ô∏è Note: DINGTALK_WEBHOOK environment variable not set"
        else
          echo "‚úÖ DINGTALK_WEBHOOK configured (secure mode)"
        fi
        
    - name: Run multi-index investment assistant
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
      run: |
        echo "üöÄ Starting multi-index analysis..."
        echo "‚úÖ DingTalk Webhook configured (secure mode)"
        set -x
        python main_multi.py 2>&1 | tee execution_log.txt
        EXIT_CODE=${PIPESTATUS[0]}
        set +x
        echo "Program exit code: $EXIT_CODE"
        if [ $EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Multi-index analysis executed successfully"
        else
          echo "‚ùå Multi-index analysis failed, exit code: $EXIT_CODE"
          echo "=== Detailed error log ==="
          cat execution_log.txt
        fi
        
    - name: Check if reports directory exists
      run: |
        if [ -d "reports" ]; then
          echo "REPORTS_EXIST=true" >> $GITHUB_ENV
        else
          echo "REPORTS_EXIST=false" >> $GITHUB_ENV
        fi
      
    - name: Upload reports as artifact
      uses: actions/upload-artifact@v4
      if: env.REPORTS_EXIST == 'true'
      with:
        name: daily-report-${{ github.run_number }}-reports
        path: reports/
        retention-days: 7
        
    - name: Check if log files exist
      run: |
        if [ -n "$(ls *.log 2>/dev/null)" ] || [ -f "execution_log.txt" ]; then
          echo "LOGS_EXIST=true" >> $GITHUB_ENV
        else
          echo "LOGS_EXIST=false" >> $GITHUB_ENV
        fi
      
    - name: Upload logs as artifact
      uses: actions/upload-artifact@v4
      if: env.LOGS_EXIST == 'true'
      with:
        name: daily-report-${{ github.run_number }}-logs
        path: |
          *.log
          execution_log.txt
        retention-days: 7
        
    - name: System status check
      if: always()
      run: |
        echo "üñ•Ô∏è System information:"
        uname -a
        echo "\nüì¶ Python environment:"
        python --version
        pip list | grep -E "(pandas|requests|matplotlib|openpyxl)"
        echo "\nüåê Network check:"
        curl -s -o /dev/null -w "%{http_code}" https://www.baidu.com && echo " Baidu access normal" || echo " Baidu access failed"
        curl -s -o /dev/null -w "%{http_code}" https://oapi.dingtalk.com && echo " DingTalk API access normal" || echo " DingTalk API access failed"
      
    - name: Error log output
      if: always()
      run: |
        echo "üö® Output all possible log content:"
        echo "=== Check current directory files ==="
        ls -la
        echo "\n=== Check log file content ==="
        for logfile in *.log; do
          if [ -f "$logfile" ]; then
            echo "\n--- $logfile content ---"
            tail -n 50 "$logfile"
          fi
        done
        if [ ! -f "multi_index_dividend_analyzer.log" ]; then
          echo "\n--- Expected log file not found ---"
        fi
        echo "\n=== Check report files ==="
        if [ -d "reports" ]; then
          echo "Report directory exists:"
          find reports -type f -name "*.html" -o -name "*.png" | head -10
        else
          echo "Report directory does not exist"
        fi