name: 部署决策报告到GitHub Pages

on:
  workflow_run:
    workflows: ["AI投研助手 - 多指数每日报告"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        ref: main
    
    - name: 下载生成的报告
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: ${{ github.event.workflow_run.id }},
          });
          
          const reportArtifact = artifacts.data.artifacts.find(
            artifact => artifact.name.includes('daily-report') && artifact.name.includes('reports')
          );
          
          if (reportArtifact) {
            console.log(`找到报告artifact: ${reportArtifact.name}`);
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: reportArtifact.id,
              archive_format: 'zip',
            });
            
            const fs = require('fs');
            const path = require('path');
            fs.writeFileSync('/tmp/reports.zip', Buffer.from(download.data));
            
            // 解压到当前目录
            const { execSync } = require('child_process');
            execSync('unzip -o /tmp/reports.zip -d .');
            
            console.log('报告下载并解压完成');
          } else {
            console.log('未找到报告artifact，将生成默认报告');
            // 如果没有artifact，运行一次分析生成报告
            const { execSync } = require('child_process');
            execSync('python -m pip install -r requirements.txt');
            execSync('pip install xlrd>=2.0.1');
            execSync('python main_multi_fixed.py');
          }
    
    - name: 设置GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: 上传到GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './reports'
    
    - name: 部署到GitHub Pages
      uses: actions/deploy-pages@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 生成访问链接
      run: |
        echo "GitHub Pages部署完成！"
        echo "报告可通过以下链接访问："
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "具体报告文件："
        if [ -d "reports" ]; then
          find reports -name "*.html" -type f | while read file; do
            filename=$(basename "$file")
            echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$filename"
          done
        fi