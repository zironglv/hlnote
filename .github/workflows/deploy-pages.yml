name: éƒ¨ç½²å†³ç­–æŠ¥å‘Šåˆ°GitHub Pages

on:
  workflow_run:
    workflows: ["Investment Report Generator"]  # ä¿®å¤ï¼šä½¿ç”¨å®é™…çš„å·¥ä½œæµåç§°
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        ref: main
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install xlrd>=2.0.1
    
    - name: å°è¯•ä¸‹è½½artifactæˆ–ç”ŸæˆæŠ¥å‘Š
      run: |
        echo "å°è¯•ä¸‹è½½artifact..."
        # å°è¯•ä¸‹è½½artifact
        if gh run download ${{ github.event.workflow_run.id }} -n daily-reports -D ./reports 2>/dev/null; then
          echo "âœ… æˆåŠŸä¸‹è½½artifact"
        else
          echo "âŒ æ— æ³•ä¸‹è½½artifactï¼Œå¯èƒ½çš„åŸå› :"
          echo "  1. Investment Report Generator å·¥ä½œæµæœªè¿è¡Œ"
          echo "  2. Artifactä¸Šä¼ å¤±è´¥"
          echo "  3. Artifactå·²è¿‡æœŸ"
          echo "  4. å·¥ä½œæµåç§°ä¸åŒ¹é…"
          echo ""
          echo "å°†ç›´æ¥åœ¨éƒ¨ç½²å·¥ä½œæµä¸­ç”ŸæˆæŠ¥å‘Š..."
          
          # å®‰è£…ä¾èµ–
          echo "å®‰è£…ä¾èµ–..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install xlrd>=2.0.1
          
          # ç”ŸæˆæŠ¥å‘Š
          echo "ç”ŸæˆæŠ•èµ„æŠ¥å‘Š..."
          python main_multi_fixed.py
          
          if [ -d "reports" ]; then
            echo "âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸ"
          else
            echo "âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œåˆ›å»ºé»˜è®¤é¡µé¢"
            mkdir -p reports
            cat > reports/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AIæŠ•ç ”åŠ©æ‰‹</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 2rem; background: #f5f7fa; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #2E86AB; }
    .error { color: #d73a49; padding: 1rem; background: #ffeef0; border-radius: 5px; margin: 1rem 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ˆ AIæŠ•ç ”åŠ©æ‰‹</h1>
    <div class="error">
      <strong>æŠ¥å‘Šç”Ÿæˆé‡åˆ°é—®é¢˜</strong><br>
      è¯·æ£€æŸ¥GitHub Actionså·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚
    </div>
    <p>å·¥ä½œæµè¿è¡ŒID: ${{ github.event.workflow_run.id }}</p>
    <p>ä»“åº“: ${{ github.repository }}</p>
  </div>
</body>
</html>
EOF
          fi
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: ä¸Šä¼ åˆ°GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: éƒ¨ç½²åˆ°GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ç”Ÿæˆè®¿é—®é“¾æ¥
      run: |
        echo "GitHub Pageséƒ¨ç½²å®Œæˆï¼"
        echo "æŠ¥å‘Šå¯é€šè¿‡ä»¥ä¸‹é“¾æ¥è®¿é—®ï¼š"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "å…·ä½“æŠ¥å‘Šæ–‡ä»¶ï¼š"
        if [ -d "reports" ]; then
          find reports -name "*.html" -type f | while read file; do
            echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$file"
          done
        fi